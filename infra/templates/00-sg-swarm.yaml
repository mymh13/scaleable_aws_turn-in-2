AWSTemplateFormatVersion: '2010-09-09'
Description: Security Group for Swarm (SSH, HTTP, Viz, Swarm ports)

Parameters:
  StackNamePrefix:
    Type: String
  VpcId:
    Type: AWS::EC2::VPC::Id
  AllowedSshCidr:
    Type: String

Resources:
  SwarmSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub '${StackNamePrefix}-swarm-sg'
      VpcId: !Ref VpcId
      # Only non-self-referencing rules here
      SecurityGroupIngress:
        # SSH (locked to your IP)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref AllowedSshCidr
        # HTTP 80 (world)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        # Visualizer 8080 (world)
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
      # Egress is outward traffic
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${StackNamePrefix}-swarm-sg'

  # Self-referencing rules as separate resources (avoids circular dependency)
  IngressSwarmMgmt2377:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SwarmSG
      IpProtocol: tcp
      FromPort: 2377
      ToPort: 2377
      SourceSecurityGroupId: !Ref SwarmSG

  IngressGossipTCP7946:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SwarmSG
      IpProtocol: tcp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref SwarmSG

  IngressGossipUDP7946:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SwarmSG
      IpProtocol: udp
      FromPort: 7946
      ToPort: 7946
      SourceSecurityGroupId: !Ref SwarmSG

  IngressOverlayUDP4789:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !Ref SwarmSG
      IpProtocol: udp
      FromPort: 4789
      ToPort: 4789
      SourceSecurityGroupId: !Ref SwarmSG

Outputs:
  SwarmSecurityGroupId:
    Value: !Ref SwarmSG